########################################################################################################
# GLCM.R
#
# Analysis of malware textures using gray co-occurrence matrices
#
# Author: Eduarda Chagas
# Date : Set 2020
# Contact: eduarda.chagas@dcc.ufmg.br
########################################################################################################

############################################# Packages #################################################
if(!require(gtools)){
  install.packages("gtools")
  require(gtools)
}
if(!require(radiomics)){
  install.packages("radiomics")
  require(radiomics)
}
if(!require(OpenImageR)){
  install.packages("OpenImageR")
  require(OpenImageR)
}

###################################### Function of Analysis ##########################################

GLCM.analysis <- function(){
  n.images = 9339
  glcm.data = matrix(nrow = n.images, ncol = 32)
  
  for(j in 1:n.images){
    img = readImage(paste0("../IMG/X[", j-1,  "].png"))
    img = img[,,1]
    img = t(apply(img, 2, rev)) 
    #image(img, col  = gray((0:255)/255))
    
    glcm.data[j,] = unlist(c(
      calc_features(glcm(img, angle = 0, d = 1, n_grey = 32), features = c("glcm_energy", "glcm_contrast", "glcm_correlation", "glcm_homogeneity1")),
      calc_features(glcm(img, angle = 45, d = 1, n_grey = 32), features = c("glcm_energy", "glcm_contrast", "glcm_correlation", "glcm_homogeneity1")),
      calc_features(glcm(img, angle = 90, d = 1, n_grey = 32), features = c("glcm_energy", "glcm_contrast", "glcm_correlation", "glcm_homogeneity1")),
      calc_features(glcm(img, angle = 135, d = 1, n_grey = 32), features = c("glcm_energy", "glcm_contrast", "glcm_correlation", "glcm_homogeneity1")),
      calc_features(glcm(img, angle = 0, d = 2, n_grey = 32), features = c("glcm_energy", "glcm_contrast", "glcm_correlation", "glcm_homogeneity1")),
      calc_features(glcm(img, angle = 45, d = 2, n_grey = 32), features = c("glcm_energy", "glcm_contrast", "glcm_correlation", "glcm_homogeneity1")),
      calc_features(glcm(img, angle = 90, d = 2, n_grey = 32), features = c("glcm_energy", "glcm_contrast", "glcm_correlation", "glcm_homogeneity1")),
      calc_features(glcm(img, angle = 135, d = 2, n_grey = 32), features = c("glcm_energy", "glcm_contrast", "glcm_correlation", "glcm_homogeneity1"))
    ))
    cat("Malware ", j, " of ", n.images, "\n")
  }
  write.csv(glcm.data,'../Data/GLCM.csv', row.names = FALSE)
}

GLCM.analysis()